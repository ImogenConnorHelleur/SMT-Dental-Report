---
title: "Dental Data Pack"
subtitle: "National"
author: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  slidy_presentation: default
  beamer_presentation:
    includes:
      in_header: slide_format2.tex
sansfont: Calibri Light
fontsize: 8pt
classoption: aspectratio = 169
params:
  level: "National"
  region_STP_name: NULL
---

```{r include = FALSE}
library(tidyverse)
library(readxl)
source("../R/SMT_functions.R")
source("../R/format_SMT_data.R")

#load in raw data
UDA_calendar_data <- readRDS("../data/cleaned_data_up_to_september/UDA_calendar_data.rds")
UOA_calendar_data <- readRDS("../data/cleaned_data_up_to_september/UOA_calendar_data.rds")
UDA_scheduled_data <- readRDS("../data/cleaned_data_up_to_september/UDA_scheduled_data.rds")
UOA_scheduled_data <- readRDS("../data/cleaned_data_up_to_september/UOA_scheduled_data.rds")
historical_UDA_scheduled_data <- readRDS("../data/cleaned_data_up_to_september/historical_UDA_scheduled_data.rds")

#load in historic data not available in raw
slide5_UDA_delivery_historic <- readRDS("../data/cleaned_data_up_to_august/slide5_UDA_delivery_historic.rds")
slide7_UOA_delivery_historic <- readRDS("../data/cleaned_data_up_to_august/slide7_UOA_delivery_historic.rds")
slide8_banded_CoT_historic <- readRDS("../data/cleaned_data_up_to_august/slide8_banded_CoT_historic.rds")

prototype_contracts <- read_excel("../data/prototype_contracts.xls")

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Contents 

#### Calendar data 2021/2022 (explanation slide 3)
###### April to September data only:
* UDA contracts achieving 60% (4 and 5)
* UOA contracts achieving 80% (8 and 9)

#### Scheduled data activity slides (explanation slide 3)
* Total UDA activity scaled up by 12 (6)
* Total UOA activity scaled up by 12 (10)
* Historic banded Courses of Treatment comparison (12)
* Total urgent FP17 form count 2019/2020 to 2020/2021 (13)  

*Please Note: Slides 4, 5, 8 and 9 use calendar data as a measure of activity for the first half of the 2021-2022 year.*
*Slides 6, 7, 10-13 use scheduled data, as per previous SMT data packs.*
*The scheduled data is from 16th June - 16th July and is fixed.*

## Calendar and scheduled data 
### Calendar data explanation 

* Slides 4, 5, 8 and 9 are based on calendar month data
* Calendar data is based on courses of treatment completed within an entire month, for example 1st February to 28th Feb
* For calendar data if a COT was completed in February but not declared till March, that activity would still be registered as
occurring in February.
* Calculation has changed from last month- rather than taking an average of all providers percentage activity to date, the activity %
is now based on total number of UDA/Os delivered as a % of the total number of UDA/Os expected by September (60%/80%
threshold).

### Scheduled data explanation
* Slides 6, 7, 10-13 are based on scheduled data
* The scheduling time period is usually between the 20th of one month and the 20th of the next month i.e., 21st April to the
19th May. That means that any Mandatory contract COT completed after this period will not be included in the May
scheduled data. However, if for example a COT was completed on May 1st, but reported to the BSA after the end of the
reporting period (April 21st â€“ May 19th), that activity would go into the following scheduled period. As a result, the
scheduling period can be considered fixed.


## UDA activity data 
```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_to_target(data = UDA_calendar_data, 
                       UDAorUOA = "UDA", 
                       level = params$level, 
                       region_STP_name = params$region_STP_name)
```

* This graph shows the average monthly performance of the **`r get_num_contracts()`** GDS/PDS/PDS+ contracts 
(with annual contracted UDAs of greater than or equal to 100) measured against the minimum monthly 
activity required (16.7%) to reach the 60% cumulative target threshold by September.  
* N.B. Last month's delivery may be marginally different to what was reported last month 
due to COTs not being registered within the calendar month. See slide 3 for more detail 
on scheduled and calendar 
data.



## UDA cumulative activity data

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_cumulative_UDA_UOA_to_target(data = UDA_calendar_data, 
                                  UDAorUOA = "UDA", 
                                  level = params$level, 
                                  region_STP_name = params$region_STP_name)
```

* This graph shows the cumulative (Year-to-date) activity of the **`r get_num_contracts()`** GDS/PDS/PDS+ 
contracts measured against the expected monthly total activity to achieve the H1 2021/22 
activity threshold by September. The graph measures the total cumulative UDAs performed
divided by the total expected activity.

* From April to `r format(Sys.Date() - lubridate::month(1), "%B")` **`r get_num_contracts_on_target()`** 
contracts (**`r round(get_num_contracts_on_target()*100/get_num_contracts())`%**) 
have delivered the required UDAs or more towards the H1 2021/22 activity threshold by the end of September.


## UDA delivery 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_delivery(data = UDA_scheduled_data, existing_data = slide5_UDA_delivery_historic, UDAorUOA = "UDA")
```

* This graph shows the average UDA delivery as a % of
contracted activity when each month has been scaled up to
12 months. The graph uses scheduled data to measure the
activity.

## UDA delivery profile 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_delivery_profile(data = UDA_scheduled_data,
                          calendar_data = UDA_calendar_data,
                          UDAorUOA = "UDA",
                          level = params$level, 
                          region_STP_name = params$region_STP_name)
```

* The graph shows the proportion of practices delivering
between a certain % group of contracted UDA activity if performance for that
month is annualised. This uses scheduled data.

## UOA activity data 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_to_target(data = UOA_calendar_data, 
                       UDAorUOA = "UOA", 
                       level = params$level, 
                       region_STP_name = params$region_STP_name)
```

* This chart shows the average monthly performance of
the **`r get_num_contracts(data = UOA_calendar_data, remove_prototypes = T, scheduled_data = UOA_scheduled_data, UDAorUOA = "UOA")`** 
GDS/PDS contracts (with annual contracted UOAs of
greater than or equal to 100) measured against the minimum
activity required (16.7%) to reach the 80% threshold by September.
* N.B. Last month's delivery may be marginally different to what was reported last month 
due to COTs not being registered within the calendar month. See slide 3 for more detail 
on scheduled and calendar 
data.

## UOA cumulative activity data 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_cumulative_UDA_UOA_to_target(data = UOA_calendar_data, 
                                  UDAorUOA = "UOA", 
                                  level = params$level, 
                                  region_STP_name = params$region_STP_name)
```

* This chart shows the cumulative (Year-to-date) average
activity of the **`r get_num_contracts(UOA_calendar_data, remove_prototypes = T, UOA_scheduled_data, "UOA")`** 
GDS/PDS contracts) measured against the
expected monthly activity to achieve the 80% threshold by
September. The graph measures the total cumulative UOAs
performed divided by the total expected activity of the 80%
threshold.
* From April to `r format(Sys.Date() - lubridate::month(1), "%B")` **`r get_num_contracts_on_target(UOA_calendar_data, remove_prototypes = T, UOA_scheduled_data, UDAorUOA = "UOA")`** contracts (**`r round(get_num_contracts_on_target(UOA_calendar_data, remove_prototypes = T, UOA_scheduled_data, UDAorUOA = "UOA")*100/get_num_contracts(UOA_calendar_data, remove_prototypes = T, UOA_scheduled_data, "UOA"))`%**) have delivered 
the required UDAs or more towards the 80% threshold.

## UOA delivery 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_delivery(data = UOA_scheduled_data, 
                      existing_data = slide7_UOA_delivery_historic, 
                      UDAorUOA = "UOA")
```

* This graph shows the average UOA delivery as a % of contracted
activity when each month has been scaled up to 12 months. The
graph uses scheduled data to measure the activity. 

## UOA delivery profile

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_UDA_UOA_delivery_profile(data = UOA_scheduled_data,
                          calendar_data = UOA_calendar_data,
                          UDAorUOA = "UOA",
                          level = params$level, 
                          region_STP_name = params$region_STP_name)
```

* The graph shows the proportion of practices delivering
between a certain % group of contracted UOA activity if performance for that 
month is annualised. 
This uses scheduled data. 

## Time series of banded Courses of Treatment 
```{r echo = FALSE, warning = FALSE, fig.height=5}
plot_banded_CoT(data = UDA_scheduled_data, 
                calendar_data = UDA_calendar_data,
                historic_data = historical_UDA_scheduled_data,
                level = params$level, 
                region_STP_name = params$region_STP_name)
```

## Urgent treatment form submissions 

```{r echo = FALSE, warning = FALSE, fig.height=4}
plot_urgent_form_submissions(data = UDA_scheduled_data, 
                calendar_data = UDA_calendar_data,
                historic_data = historical_UDA_scheduled_data,
                level = params$level, 
                region_STP_name = params$region_STP_name)
```

* This graph shows the number of urgent treatment forms
declared per month across financial years.
* The urgent treatment form count in **`r format(Sys.Date() - lubridate::month(1), "%B")` 2021** was
**`r get_num_urgent_forms()`**, whilst in **`r format(Sys.Date() - lubridate::month(1), "%B")` 2019** this number was
**`r get_num_urgent_forms_2019()`**, which is a **`r round((get_num_urgent_forms() - get_num_urgent_forms_2019()) *100 / get_num_urgent_forms_2019())`%** change from the pre-COVID
world. 